# Run unit tests daily.
#
# This is different from container rebuilds, where the tests "gate" the new version. The last
# container is used, always. That means, failures for this workflow signal breakages that are
# unrelated to the actual container builds.
#
# This should help as an additional data source to diagnose issues when things "randomly fail
# everywhere". Tests running here are not affected by any changes. In all other cases, these tests
# run after a change:
#    - code changes on PRs
#    - after container rebuilds
#    - after merges
#
# Ideally, these tests run on the same hashes as the merge tests, and so help detect which
# differences actually matter for the breakage.
#
# Warning: This differs from the pull request tests, both steps and matrix. Don't copypaste.

name: Run validation tests daily
on:
  # 2 AM
  schedule:
    - cron: 0 2 * * *
  workflow_dispatch:

permissions:
  contents: read

jobs:
  define-matrix:
    uses: ./.github/workflows/define-matrix.yml
    with:
      target_branch: ''  # Empty = all releases

  unit-tests:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: define-matrix
    # Don't run scheduled workflows on forks.
    if: github.event_name != 'schedule' || github.repository == 'rhinstaller/anaconda'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.define-matrix.outputs.releases) }}

    env:
      CI_TAG: '${{ matrix.ci_tag }}'
      # Always avoid using cache because cache is not correctly invalidated.
      CONTAINER_BUILD_ARGS: '--no-cache ${{ matrix.build-args }}'

    steps:
      - name: Clone repository
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.target_branch }}

      - name: Run tests in anaconda-ci container
        run: |
          # put the log in the output, where it's easy to read and link to
          make -f Makefile.am container-ci || { cat test-logs/test-suite.log; exit 1; }

      - name: Upload test and coverage logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: 'logs (${{ matrix.release }})'
          path: test-logs/*

  rpm-tests:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: define-matrix
    # Don't run scheduled workflows on forks.
    if: github.event_name != 'schedule' || github.repository == 'rhinstaller/anaconda'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.define-matrix.outputs.releases) }}

    env:
      CI_TAG: '${{ matrix.ci_tag }}'
      # Always avoid using cache because cache is not correctly invalidated.
      CONTAINER_BUILD_ARGS: '--no-cache ${{ matrix.build-args }}'

    steps:
      - name: Clone repository
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.target_branch }}

      - name: Run RPM tests in container
        run: make -f Makefile.am container-rpm-test

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: 'logs-rpm-test (${{ matrix.release }})'
          path: test-logs/*
