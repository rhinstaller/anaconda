# ======================================
# WARNING!
# THIS FILE IS GENERATED FROM A TEMPLATE
# DO NOT EDIT THIS FILE MANUALLY!
# ======================================
# The template is located in: define-matrix.yml.j2


name: Define Matrix

on:
  workflow_call:
    inputs:
      target_branch:
        description: 'Target branch to filter matrix for (empty for all branches)'
        required: false
        type: string
        default: ''
      use_full_releases:
        description: 'Set to "false" to replace current branch in "release" with empty string. This makes name of the check for the default release per branch always have the same name, so that it can be added to required checks on GitHub'
        required: false
        type: string
        default: 'true'
    outputs:
      releases:
        description: 'Matrix data for the target branch or all branches if no target specified'
        value: ${{ jobs.define-matrix.outputs.releases }}

jobs:
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ steps.get_matrix.outputs.matrix }}
    steps:
      - name: Get matrix for target branch
        id: get_matrix
        run: |
          MATRIX_DATA='{"main": [{"ci_tag": "fedora-rawhide", "release": "fedora-rawhide", "target_branch": "main"}, {"ci_tag": "fedora-43", "release": "fedora-43", "target_branch": "main"}], "rhel-10": [{"ci_tag": "rhel-10", "release": "rhel-10", "target_branch": "rhel-10"}], "rhel-9": [{"ci_tag": "rhel-9", "release": "rhel-9", "target_branch": "rhel-9"}]}'

          if [ -z "${{ inputs.target_branch }}" ]; then
            # Get all releases from all branches using map
            MATRIX=$(echo "$MATRIX_DATA" | jq -c 'map(.[]) | flatten')
          else
            # Get releases for specific branch
            MATRIX=$(echo "$MATRIX_DATA" | jq -c ".[\"${{ inputs.target_branch }}\"]")
          fi

          if [ "${{ inputs.use_full_releases }}" != "true" ]; then
            # Filter release names: empty for most, full name for non-rawhide fedora releases
            MATRIX=$(echo "$MATRIX" | jq -c '
              map(. + {
                "release": (
                  if (.release | startswith("fedora-")) and (.release != "fedora-rawhide")
                  then .release
                  else ""
                  end
                )
              })
            ')
          else
            # Ensure MATRIX is always an array for consistent output format
            MATRIX=$(echo "$MATRIX" | jq -c 'if type == "array" then . else [.] end')
          fi

          # Create matrix with release array and include array
          RELEASES=$(echo "$MATRIX" | jq -c '[.[].release]')
          echo "matrix={\"release\":$RELEASES,\"include\":$MATRIX}" >> $GITHUB_OUTPUT
