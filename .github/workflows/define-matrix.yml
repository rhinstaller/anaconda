name: Define Matrix

on:
  workflow_call:
    inputs:
      target_branch:
        description: 'Target branch to filter matrix for (empty for all branches)'
        required: false
        type: string
        default: ''
      use_full_releases:
        description: 'Set to "false" to replace current branch in "release" with empty string. This makes name of the check for the default release per branch always have the same name, so that it can be added to required checks on GitHub'
        required: false
        type: string
        default: 'true'
      ignore_releases:
        description: 'Comma-separated list of releases to ignore in the matrix output'
        required: false
        type: string
        default: ''
    outputs:
      releases:
        description: 'Matrix data for the target branch or all branches if no target specified'
        value: ${{ jobs.define-matrix.outputs.releases }}

jobs:
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ steps.get_matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Generate matrix data
        id: get_matrix
        run: |
          # Build command arguments array
          args=("python3" "scripts/define-matrix.py")

          # Add target branch if specified
          if [ -n "${{ inputs.target_branch }}" ]; then
            args+=("${{ inputs.target_branch }}")
          fi

          # Add use_full_releases flag
          if [ "${{ inputs.use_full_releases }}" = "false" ]; then
            args+=("--no-use-full-releases")
          fi

          # Add skip releases if specified
          if [ -n "${{ inputs.ignore_releases }}" ]; then
            args+=("--skip-releases" "${{ inputs.ignore_releases }}")
          fi

          MATRIX=$("${args[@]}")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
