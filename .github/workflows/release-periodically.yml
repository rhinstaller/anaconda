# ======================================
# WARNING!
# THIS FILE IS GENERATED FROM A TEMPLATE
# DO NOT EDIT THIS FILE MANUALLY!
# ======================================
# The template is located in: release-periodically.yml.j2

name: Release periodically
# Create a GitHub release on schedule
# This only makes a tag and pushes it, which is then picked up by another action that builds
# the tarball and posts the actual release entity/page with it. See: tag-release.yml
# If the branch already has a tag at the last commit, there is nothing to release, so abort.

on:
  workflow_dispatch:
  schedule:
    - cron: 48 4 * * TUE
    # GH workers run on UTC+0 time. The timing is so that the draft can be reviewed at start of
    # work day in Brno which is in UTC+1 or UTC+2.
    # Tuesdays are the traditional rawhide anaconda release day, so that there are enough days to
    # unbreak things.

permissions:
  contents: write

jobs:
  check-date:
    # run only on even weeks
    runs-on: ubuntu-latest
    steps:
      - name: Check if the week number is even
        id: check
        run: |
          week_no=$(date +"%V")
          if [ $((10#${week_no}%2)) -eq 0 ]; then
            echo "is_even=true" >> $GITHUB_OUTPUT
          fi
    outputs:
      is_even: ${{ steps.check.outputs.is_even }}

  make-release-tag:
    # Don't run scheduled workflows on forks.
    needs: check-date
    if: ${{ (github.event_name != 'schedule' || github.repository == 'rhinstaller/anaconda') && needs.check-date.outputs.is_even == 'true' }}
    runs-on: ubuntu-latest
    environment: releases
    steps:

      - name: Check out repo
        uses: actions/checkout@v3
        with:
          ref: "master"
          fetch-depth: 0
          token: ${{ secrets.INSTALLKER_TOKEN }}

      - name: Check if already tagged
        id: check-tag
        run: |
          # expected retvals and outputs for `git describe`:
          # 128 -> fatal: no tag exactly matches 'c88a1272ffbc002042fd62ed409734c1c150cc5f'
          # 0 -> anaconda-38.6-1
          if git describe --tags --exact-match ; then
            echo "::warning:: Already tagged at HEAD, will not push a release commit."
          else
            echo "can_bump_version=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare and tag a release commit
        if: steps.check-tag.outputs.can_bump_version
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          ./scripts/makebumpver -c

      - name: Push the release commit with the tag to repo
        if: steps.check-tag.outputs.can_bump_version
        # the repo should have an access token from the checkout action
        # https://github.com/actions/checkout#Push-a-commit-using-the-built-in-token
        run: |
          tag_to_push=$(git describe --tags --exact-match)
          if [ -n "${tag_to_push}" ] ; then
            git push --atomic origin master "$tag_to_push"
          else
            exit 1
          fi

      - name: Notify in Google chat
        if: steps.check-tag.outputs.can_bump_version
        # https://developers.google.com/chat/how-tos/webhooks
        # https://developers.googleblog.com/2018/06/hangouts-chat-alerts-notifications-with.html
        run: |
          curl \
            -X POST \
            -H 'Content-Type: application/json' \
            '${{ secrets.GCHAT_URL }}' \
            -d "{\"text\": \"New release tagged, please review the Packit dist-git PR soon to be found at https://src.fedoraproject.org/rpms/anaconda/pull-requests\"}"

# This only makes a tag and pushes it, which is then picked up by another action that builds
# the tarball and posts the actual release entity/page with it.
#
# See: tag-release.yml
