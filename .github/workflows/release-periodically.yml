# ======================================
# WARNING!
# THIS FILE IS GENERATED FROM A TEMPLATE
# DO NOT EDIT THIS FILE MANUALLY!
# ======================================
# The template is located in: release-periodically.yml.j2

name: Release periodically
# Create a GitHub release on schedule

on:
  workflow_dispatch:
  schedule:
    - cron: 48 6 * * MON
    # release every monday at 6:48

permissions:
  contents: write


jobs:
  make-release-tag:
    runs-on: ubuntu-latest
    steps:

      - name: Check out repo
        uses: actions/checkout@v3
        with:
          ref: "master"
          fetch-depth: 20
          tags: true

      - name: Check if already tagged
        id: check-tag
        run: |
          # expected retvals and outputs for `git describe`:
          # 128 -> fatal: no tag exactly matches 'c88a1272ffbc002042fd62ed409734c1c150cc5f'
          # 0 -> anaconda-38.6-1
          if git describe --tags --exact-match ; then
            echo "Already tagged at HEAD, will not push another tag."
            echo "::set-output name=can-tag::false"
          else
            echo "::set-output name=can-tag::true"
          fi

        - name: Run makebumpver
          if: ${{ steps.check-tag.outputs.can-tag }}
          run: |
            git config user.name github-actions
            git config user.email github-actions@github.com
            ./scripts/makebumpver -c

        - name: Push tag to repo
          if: ${{ steps.check-tag.outputs.can-tag }}
          # the repo should have an access token from the checkout action
          # https://github.com/actions/checkout#Push-a-commit-using-the-built-in-token
          run: |
            git push --tags origin master

# This only makes a tag, which is then picked up by another action that builds the tarball
# and posts the actual release entity.
#
# See: tag-release.yml
