#!/usr/bin/python3
#
# Copyright (C) 2021 Red Hat, Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program; If not, see <http://www.gnu.org/licenses/>.

import anacondalib

from installer import Installer
from language import Language
from review import Review
from storage import Storage
from users import dbus_reset_users
from testlib import nondestructive, test_main, wait, Error  # pylint: disable=import-error
from utils import pretend_live_iso, get_pretty_name


@nondestructive
class TestBasic(anacondalib.VirtInstallMachineCase):

    def testNavigation(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)

        i.open()

        self.assertIn(
            b.attr("#app .pf-v5-c-page", "data-debug").lower(),
            ["false", "true"]
        )

        i.check_prerelease_info()
        # Do not start the installation in non-destructive tests as this performs non revertible changes
        # with the pages basically empty of common elements (as those are provided by the top-level installer widget)
        # we at least iterate over them to check this works as expected
        self.addCleanup(lambda: dbus_reset_users(self.machine))
        i.reach(i.steps.REVIEW)

        # Ensure that the 'actual' UI process is running/
        self.assertIn("/usr/libexec/webui-desktop", m.execute("ps aux"))

    def testSidebarNavigation(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)

        i.open()

        i.check_prerelease_info()

        # Test that clicking on current step does not break navigation
        i.click_step_on_sidebar()

        self.addCleanup(lambda: dbus_reset_users(self.machine))
        i.reach(i.steps.REVIEW)

        # Test going back
        steps = [
            i.steps.ACCOUNTS,
            i.steps.DISK_CONFIGURATION,
            i.steps.DISK_ENCRYPTION,
            i.steps.DISK_CONFIGURATION,
            i.steps.INSTALLATION_METHOD,
            i.steps.WELCOME,
            i.steps.WELCOME,
        ]

        for step in steps:
            if step not in i.hidden_steps:
                i.click_step_on_sidebar(step)

        i.reach(i.steps.REVIEW)

    def testLanguageScreenHiddenLive(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)
        r = Review(b)

        pretend_live_iso(self, i)

        i.open()
        i.reach(i.steps.INSTALLATION_METHOD)

        # Back button should be disabled on the first screen
        b.wait_visible(f"#installation-back-btn:not([aria-disabled={True}]")

        # For live media in the review screen language details should still be displayed
        i.reach(i.steps.REVIEW)
        r.check_language("English (United States)")

    def testAboutModal(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)

        i.open()

        # Obtain pretty name and versions from the CLI
        pretty_name = get_pretty_name(m)
        version = m.execute("anaconda --version | cut -d ' ' -f 2 | tail -1")

        # Click on the kebab
        b.click("#toggle-kebab")

        # Click on the "About" item from the dropdown
        b.click("#about-modal-dropdown-item-about")

        # Expect PRETTY_NAME to be shown in modal title
        b.wait_in_text("#about-modal-title", pretty_name)

        # Expect "Powered by Anaconda" to be shown in modal subtitle
        b.wait_in_text("#about-modal-subtitle", "Powered by Anaconda")

        # Expect About modal body to be shown
        b.wait_in_text("#about-modal-versions dt", "Anaconda")
        b.wait_in_text("#about-modal-versions dd", version.strip())

        # Expect button link for Anaconda project page to be shown
        b.wait_in_text("#anaconda-page-button", "Anaconda project page")

        # Pixel test the language step
        b.assert_pixels(
            ".pf-v5-c-about-modal-box",
            "about-modal",
            ignore=["#about-modal-versions dd"],
        )

        #Close about modal
        b.click(".pf-v5-c-button[aria-label='Close Dialog']")
        b.wait_not_present("#about-modal")

    def _testLogReview(self, b, m, idPrefix):
        # Test review of logs
        self.addCleanup(m.execute, "rm -f /tmp/webui.log")
        logfile = "/tmp/webui.log"

        self.assertFalse(self.file_exists(logfile))

        # FIXME: Remove PF5 specific selector: https://github.com/patternfly/patternfly-react/issues/9512
        # Click report issue: save reviewed log and open BZ URL
        b.click(f"#{idPrefix}-bz-report-modal.pf-v5-c-modal-box .pf-v5-c-button.pf-m-primary")

        with b.wait_timeout(20):
            b.wait(lambda: self.file_exists(logfile))

        # Reviewed log contains more than 100 lines
        wait(lambda: int(m.execute(f"wc -l {logfile} | cut -d' ' -f1").strip()) > 100)

        # Test editing of the log
        user_text = "STRING_ADDED_BY_USER_TO_LOG"
        b.set_input_text(f"#{idPrefix}-bz-report-modal-review-log", user_text)
        b.click(f"#{idPrefix}-bz-report-modal.pf-v5-c-modal-box .pf-v5-c-button.pf-m-primary")
        wait(lambda: (m.execute(f"cat {logfile}")) == user_text)

    def testReportIssue(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)

        i.open()

        # FIXME: Remove PF5 specific selector: https://github.com/patternfly/patternfly-react/issues/9512
        b.wait_not_present("#user-issue-bz-report-modal.pf-v5-c-modal-box")

        b.click("#toggle-kebab")

        b.click("#about-modal-dropdown-item-report")

        b.wait_visible("#user-issue-bz-report-modal.pf-v5-c-modal-box")

        self._testLogReview(b, m, "user-issue")

        b.click("#user-issue-dialog-cancel-btn")
        b.wait_not_present("#user-issue-bz-report-modal.pf-v5-c-modal-box")

    def testErrorHandling(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)
        l = Language(b, m)
        s = Storage(b, m)

        # BIOS boot /boot on ext4 / on xfs /home on btrfs
        disk = "/dev/vda"
        dev = "vda"
        s.partition_disk(disk, [("1MiB", "biosboot"), ("1GB", "ext4"), ("10GiB", "xfs"), ("", "ext4")])

        # Two partitions on the same disk with the same UUID raise exception in
        # Blivet
        s.set_partition_uuid(disk, 3, "66f47a35-b00e-4341-8f31-f4855fac24a2")
        s.set_partition_uuid(disk, 4, "66f47a35-b00e-4341-8f31-f4855fac24a2")

        s.udevadm_settle()

        i.open()
        i.reach(i.steps.INSTALLATION_METHOD)

        # FIXME: Remove PF5 specific selector: https://github.com/patternfly/patternfly-react/issues/9512
        b.wait_not_present("#critical-error-bz-report-modal.pf-v5-c-modal-box")

        s.rescan_disks()

        b.wait_visible("#critical-error-bz-report-modal.pf-v5-c-modal-box")

        self._testLogReview(b, m, "critical-error")

    def testJsErrorHandling(self):
        b = self.browser
        m = self.machine
        i = Installer(b, m)

        i.open()

        b.wait_not_present("#critical-error-bz-report-modal.pf-v5-c-modal-box")

        with self.assertRaises(RuntimeError):
            b.eval_js("window.setTimeout(function() {throw new Error('Unexpected JS error')}, 0);")
            # Some round trips, one of which should update the deferred exception
            for _ in range(0, 5):
                b.wait_in_text("#critical-error-bz-report-modal-details", "Error: Unexpected JS error")
                time.sleep(2)

        b.wait_visible("a:contains('Report issue'):not([disabled])")
        b.assert_pixels(
            "#critical-error-bz-report-modal.pf-v5-c-modal-box",
            "js-error-modal",
            ignore=["#critical-error-bz-report-modal-review-log"]
        )


if __name__ == '__main__':
    test_main()
